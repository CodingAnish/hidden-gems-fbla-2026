{% extends "base.html" %}

<!-- 
PASSWORD RESET PAGE
This page allows users to reset their forgotten password.
Features:
- Real-time password strength validation
- Password requirements checklist  
- Confirmation field with visual feedback
- Submit button only enabled when all requirements met
-->

{% block content %}
<!-- STYLING FOR PASSWORD RESET PAGE -->
<style>
  /* Hero section with gradient background */
  .page-hero {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
    padding: 40px 20px;
    text-align: center;
  }

  /* Main page title */
  .page-title {
    font-size: 2.2rem;
    margin: 0 0 10px 0;
    color: white;
  }

  /* Subtitle text under title */
  .page-subtitle {
    font-size: 1rem;
    margin: 0;
    color: rgba(255, 255, 255, 0.9);
  }

  /* Form container with shadow and rounded corners */
  .form-container {
    max-width: 500px;
    margin: 40px auto;
    padding: 30px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  /* Individual form field group (label + input) */
  .form-group {
    margin-bottom: 20px;
  }

  /* Form field labels */
  .form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #333;
  }

  /* Form input fields with focus states */
  .form-group input {
    width: 100%;
    padding: 12px;
    border: 2px solid #e5e7eb;
    border-radius: 6px;
    font-size: 1rem;
    box-sizing: border-box;
    transition: border-color 0.3s;
  }

  .form-group input:focus {
    outline: none;
    border-color: #f59e0b;
  }

  /* Password requirements checklist box */
  .password-requirements {
    background: #fef3c7;
    border-left: 4px solid #f59e0b;
    padding: 15px;
    border-radius: 4px;
    margin-bottom: 20px;
    font-size: 0.9rem;
    color: #78350f;
  }

  /* Unordered list for requirements items */
  .requirements-list {
    margin: 10px 0 0 0;
    padding-left: 20px;
    list-style: none;
  }

  /* Individual requirement item with checkmark animation */
  .requirements-list li {
    margin: 5px 0;
    position: relative;
    padding-left: 20px;
  }

  /* Red X mark for unmet requirements (default) */
  .requirements-list li:before {
    content: "✗";
    position: absolute;
    left: 0;
    color: #dc2626;
    font-weight: bold;
    font-size: 1.1rem;
  }

  /* Green checkmark for met requirements */
  .requirements-list li.met:before {
    content: "✓";
    color: #059669;
  }

  /* Password strength indicator (weak/medium/strong) */
  .password-strength {
    margin-top: 12px;
    padding: 10px;
    border-radius: 4px;
    font-size: 0.9rem;
    font-weight: 600;
    text-align: center;
    display: none;
  }

  /* Weak password styling (red) */
  .password-strength.weak {
    display: block;
    background: #fee2e2;
    color: #991b1b;
  }

  /* Medium password styling (yellow) */
  .password-strength.medium {
    display: block;
    background: #fef3c7;
    color: #92400e;
  }

  /* Strong password styling (green) */
  .password-strength.strong {
    display: block;
    background: #dcfce7;
    color: #166534;
  }

  /* Submit button */
  .btn {
    width: 100%;
    padding: 12px;
    background: #f59e0b;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.3s;
  }

  /* Submit button hover state */
  .btn:hover {
    background: #d97706;
  }

  /* Information box displaying account email */
  .info-box {
    background: #dbeafe;
    border-left: 4px solid #0284c7;
    padding: 15px;
    border-radius: 4px;
    margin-bottom: 20px;
    color: #0c4a6e;
    font-size: 0.95rem;
  }

  /* Info box paragraph (no margin) */
  .info-box p {
    margin: 0;
  }

  /* Back to login link container */
  .back-link {
    text-align: center;
    margin-top: 15px;
  }

  /* Back to login link styling */
  .back-link a {
    color: #10B981;
    text-decoration: none;
    font-weight: 500;
  }

  /* Back to login link hover state */
  .back-link a:hover {
    text-decoration: underline;
  }
</style>

<!-- PAGE CONTENT SECTION -->

<!-- Hero section with title and subtitle -->
<div class="page-hero">
  <h1 class="page-title">Reset Password</h1>
  <p class="page-subtitle">Set a new password for your Hidden Gems account</p>
</div>

<!-- Main form container -->
<div class="form-container">
  <!-- Account information display (which email this password reset is for) -->
  <div class="info-box">
    <p><strong>Account:</strong> {{ email }}</p>
  </div>

  <!-- Password reset form with POST submission -->
  <form method="POST" onsubmit="return validatePasswordReset()">
    <!-- Password Requirements Section - Shows user what password requirements must be met -->
    <div class="password-requirements">
      <strong>Password must have:</strong>
      <!-- Unordered list of password requirements with dynamic X/checkmark indicators -->
      <ul class="requirements-list">
        <!-- Requirement: Minimum 8 characters (checked dynamically) -->
        <li id="length-req">At least 8 characters</li>
        <!-- Requirement: At least one uppercase letter (checked dynamically) -->
        <li id="uppercase-req">One uppercase letter (A-Z)</li>
        <!-- Requirement: At least one numeric digit (checked dynamically) -->
        <li id="number-req">One number (0-9)</li>
        <!-- Requirement: At least one special character (checked dynamically) -->
        <li id="special-req">One special character (!@#$%^&*)</li>
      </ul>
      <!-- Password strength indicator (displays weak/medium/strong feedback) -->
      <div class="password-strength" id="strength-indicator"></div>
    </div>

    <!-- New Password Input Field -->
    <div class="form-group">
      <label for="password">New Password</label>
      <!-- Password input triggers validation on each keystroke -->
      <input 
        type="password" 
        id="password" 
        name="password" 
        placeholder="Enter new password"
        oninput="validatePasswordRequirements(this.value)"
        required
      />
    </div>

    <!-- Confirm Password Input Field -->
    <div class="form-group">
      <label for="confirm">Confirm Password</label>
      <!-- Confirm field triggers validation and color coding (green=match, red=mismatch) -->
      <input 
        type="password" 
        id="confirm" 
        name="confirm" 
        placeholder="Confirm password"
        oninput="validatePasswordRequirements(document.getElementById('password').value)"
        required
      />
    </div>

    <!-- Submit button (disabled until all requirements and confirmation are met) -->
    <button type="submit" class="btn" id="submit-btn" disabled style="opacity: 0.6; cursor: not-allowed;">Reset Password</button>
  </form>

  <!-- Back to Login Link - Allows user to return to login if they changed their mind -->
  <div class="back-link">
    <a href="{{ url_for('login') }}">Back to Login</a>
  </div>
</div>

<script>
/**
 * FUNCTION: validatePasswordRequirements
 * PURPOSE: Validate password in real-time and update UI with requirement status
 * TRIGGERS: Called on input to password field, runs on each keystroke
 * PARAMETERS: password (string) - the password value to validate
 * UPDATES: 
 *   - Adds/removes 'met' class to requirement list items for visual feedback
 *   - Updates strength indicator with color and text (weak/medium/strong)
 *   - Enables/disables submit button based on all requirements and confirmation match
 */
function validatePasswordRequirements(password) {
  // Get DOM elements for requirement indicators
  const lengthReq = document.getElementById('length-req');
  const uppercaseReq = document.getElementById('uppercase-req');
  const numberReq = document.getElementById('number-req');
  const specialReq = document.getElementById('special-req');
  const submitBtn = document.getElementById('submit-btn');
  const strengthIndicator = document.getElementById('strength-indicator');
  const passwordInput = document.getElementById('password');
  const confirmInput = document.getElementById('confirm');

  // TEST EACH PASSWORD REQUIREMENT USING REGEX PATTERNS
  // hasLength: Check if password has 8 or more characters
  const hasLength = password.length >= 8;
  // hasUppercase: Check if password contains at least one uppercase letter (A-Z)
  const hasUppercase = /[A-Z]/.test(password);
  // hasNumber: Check if password contains at least one numeric digit (0-9)
  const hasNumber = /[0-9]/.test(password);
  // hasSpecial: Check if password contains at least one special character (!@#$%^&*)
  const hasSpecial = /[!@#$%^&*]/.test(password);
  // passwordsMatch: Check if password field matches confirm field
  const passwordsMatch = password === confirmInput.value;

  // UPDATE VISUAL INDICATORS FOR EACH REQUIREMENT
  // Toggle 'met' class on requirement items - CSS shows checkmark when 'met' class applied
  lengthReq.classList.toggle('met', hasLength);
  uppercaseReq.classList.toggle('met', hasUppercase);
  numberReq.classList.toggle('met', hasNumber);
  specialReq.classList.toggle('met', hasSpecial);

  // CALCULATE PASSWORD STRENGTH LEVEL
  // Count how many requirements are currently met (0-4)
  const metCount = [hasLength, hasUppercase, hasNumber, hasSpecial].filter(Boolean).length;
  
  // UPDATE STRENGTH INDICATOR WITH APPROPRIATE FEEDBACK
  if (metCount === 0) {
    // No requirements met - hide strength indicator
    strengthIndicator.classList.remove('weak', 'medium', 'strong');
    strengthIndicator.textContent = '';
  } else if (metCount < 3) {
    // 1-2 requirements met - show weak password warning (red background)
    strengthIndicator.classList.remove('medium', 'strong');
    strengthIndicator.classList.add('weak');
    strengthIndicator.textContent = '⚠️ Weak password';
  } else if (metCount === 3) {
    // 3 requirements met - show medium strength (yellow background)
    strengthIndicator.classList.remove('weak', 'strong');
    strengthIndicator.classList.add('medium');
    strengthIndicator.textContent = '✓ Medium strength';
  } else {
    // All 4 requirements met - show strong password (green background)
    strengthIndicator.classList.remove('weak', 'medium');
    strengthIndicator.classList.add('strong');
    strengthIndicator.textContent = '✓ Strong password';
  }

  // ENABLE/DISABLE SUBMIT BUTTON BASED ON VALIDATION
  // Submit button is only enabled when ALL requirements are met AND passwords match
  const allMet = hasLength && hasUppercase && hasNumber && hasSpecial && passwordsMatch;
  submitBtn.disabled = !allMet;
  // Visual feedback: reduces opacity when disabled, full opacity when enabled
  submitBtn.style.opacity = allMet ? '1' : '0.6';
  // Cursor feedback: shows pointer when enabled, "not-allowed" when disabled
  submitBtn.style.cursor = allMet ? 'pointer' : 'not-allowed';
}

/**
 * FUNCTION: validatePasswordReset
 * PURPOSE: Server-side validation before form submission
 * TRIGGERS: Called when form is submitted via form onsubmit attribute
 * RETURNS: true (allow form submission) or false (prevent form submission)
 * VALIDATION: Double-checks that password meets all requirements before sending to server
 */
function validatePasswordReset() {
  // Get password and confirm values from form inputs
  const password = document.getElementById('password').value;
  const confirm = document.getElementById('confirm').value;

  // VALIDATE THAT PASSWORDS MATCH
  // Alert user if confirmation password doesn't match password field
  if (password !== confirm) {
    alert('Passwords do not match!');
    return false; // Prevent form submission
  }

  // DOUBLE CHECK ALL PASSWORD REQUIREMENTS VIA REGEX
  // Check minimum length (8 characters)
  const hasLength = password.length >= 8;
  // Check for at least one uppercase letter
  const hasUppercase = /[A-Z]/.test(password);
  // Check for at least one numeric digit
  const hasNumber = /[0-9]/.test(password);
  // Check for at least one special character
  const hasSpecial = /[!@#$%^&*]/.test(password);

  // VERIFY ALL REQUIREMENTS ARE MET
  // Alert user if any requirement is not met
  if (!hasLength || !hasUppercase || !hasNumber || !hasSpecial) {
    alert('Password does not meet all requirements!');
    return false; // Prevent form submission
  }

  // All validations passed - allow form submission
  return true;
}

/**
 * EVENT HANDLER: DOMContentLoaded
 * PURPOSE: Run initialization code after page HTML is fully loaded
 * BEHAVIOR: Sets up visual feedback for password confirmation field
 *   - Green border/background when passwords match
 *   - Red border/background when passwords don't match
 *   - Triggers validation on each keystroke
 */
document.addEventListener('DOMContentLoaded', function() {
  // Get references to password input elements
  const passwordInput = document.getElementById('password');
  const confirmInput = document.getElementById('confirm');
  
  // Only proceed if both input fields exist on the page
  if (passwordInput && confirmInput) {
    // ADD VISUAL FEEDBACK TO CONFIRM FIELD AS USER TYPES
    // This event listener runs every time the user types in the confirm field
    confirmInput.addEventListener('input', function() {
      // Get current password value
      const password = passwordInput.value;
      
      // IF PASSWORDS MATCH: Apply green styling (success state)
      if (this.value && this.value === password) {
        this.style.borderColor = '#10b981';      // Green border
        this.style.backgroundColor = '#f0fdf4';  // Light green background
      } 
      // ELSE IF CONFIRM FIELD HAS VALUE BUT DOESN'T MATCH: Apply red styling (error state)
      else if (this.value) {
        this.style.borderColor = '#ef4444';      // Red border
        this.style.backgroundColor = '#fef2f2';  // Light red background
      } 
      // ELSE IF CONFIRM FIELD IS EMPTY: Reset to default styling
      else {
        this.style.borderColor = '#e5e7eb';      // Gray border
        this.style.backgroundColor = 'white';     // White background
      }
      
      // Trigger validation check to update strength indicator and button state
      validatePasswordRequirements(password);
    });

    // INITIALIZE VALIDATION IF PASSWORD FIELD HAS VALUE ON PAGE LOAD
    // This handles cases where form is pre-populated (shouldn't happen on password reset)
    if (passwordInput.value) {
      validatePasswordRequirements(passwordInput.value);
    }
  }
});
</script>
{% endblock %}
